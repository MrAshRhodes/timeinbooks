#!/usr/bin/env node

/**
 * Filter out Bible quotes from quotes.js
 * This script removes all quotes where title === "The King James Version of the Bible"
 */

const fs = require('fs');
const path = require('path');

const QUOTES_FILE = path.join(__dirname, '..', 'quotes.js');

console.log('Reading quotes.js...');
const quotesContent = fs.readFileSync(QUOTES_FILE, 'utf8');

// Extract the QUOTES object
const quotesMatch = quotesContent.match(/const QUOTES = (\{[\s\S]*\});/);
if (!quotesMatch) {
    console.error('Could not find QUOTES object in quotes.js');
    process.exit(1);
}

// Parse the quotes
console.log('Parsing quotes object...');
const QUOTES = eval('(' + quotesMatch[1] + ')');

// Filter out Bible quotes
console.log('Filtering out Bible quotes...');
let totalQuotes = 0;
let bibleQuotes = 0;
let remainingQuotes = 0;

const filtered = {};
for (const [time, quotes] of Object.entries(QUOTES)) {
    totalQuotes += quotes.length;

    const nonBibleQuotes = quotes.filter(q => {
        const isBible = q.title === "The King James Version of the Bible";
        if (isBible) {
            bibleQuotes++;
        }
        return !isBible;
    });

    remainingQuotes += nonBibleQuotes.length;

    // Only keep time slots that still have quotes
    if (nonBibleQuotes.length > 0) {
        filtered[time] = nonBibleQuotes;
    }
}

console.log('\nStatistics:');
console.log(`Total quotes before: ${totalQuotes}`);
console.log(`Bible quotes removed: ${bibleQuotes}`);
console.log(`Remaining quotes: ${remainingQuotes}`);
console.log(`Percentage removed: ${((bibleQuotes / totalQuotes) * 100).toFixed(2)}%`);

// Generate new quotes.js file
console.log('\nGenerating new quotes.js...');
const newContent = `/**
 * Quotes Database (Generated by quote-scraper)
 * Total Quotes: ${remainingQuotes}
 * Last Updated: ${new Date().toISOString()}
 * Note: Bible quotes have been removed for inclusivity
 */

const QUOTES = ${JSON.stringify(filtered, null, 2)};

// Export for Node.js
if (typeof module !== 'undefined' && module.exports) {
    module.exports = QUOTES;
}
`;

// Create backup
const backupFile = QUOTES_FILE + '.backup';
console.log(`Creating backup at ${backupFile}...`);
fs.copyFileSync(QUOTES_FILE, backupFile);

// Write new file
console.log(`Writing filtered quotes to ${QUOTES_FILE}...`);
fs.writeFileSync(QUOTES_FILE, newContent, 'utf8');

console.log('\nâœ… Done! Bible quotes have been removed from quotes.js');
console.log(`ðŸ“¦ Backup saved to: ${backupFile}`);
